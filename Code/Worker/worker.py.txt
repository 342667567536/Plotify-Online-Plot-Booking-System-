"""
Simple worker that polls MongoDB for pending bookings and prints a notification.
Replace the print with real email/SMS/Push logic (SendGrid, Twilio, etc.)
"""
import os
import time
from pymongo import MongoClient
from dotenv import load_dotenv

load_dotenv()

MONGO_URI = os.getenv('MONGO_URI', 'mongodb://mongo:27017/plotsdb')
client = MongoClient(MONGO_URI)
db = client.get_database()

def notify_pending():
    bookings = list(db.booking.find({"status":"pending"}))
    for b in bookings:
        user = db.user.find_one({"_id": b['user']})
        plot = db.plot.find_one({"_id": b['plot']})
        print(f"[Worker] Notify: booking {b['_id']} by user {b['user']} for plot {b['plot']}")
        # Example: after notifying, mark as "notified" or leave to admin confirmation
        db.booking.update_one({"_id": b['_id']}, {"$set": {"notified_at": time.time()}})

if __name__ == "__main__":
    while True:
        try:
            notify_pending()
        except Exception as e:
            print("Worker error:", e)
        time.sleep(20)